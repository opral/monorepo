-- original SQL --
select * from (
WITH
  -- Source side should expose explicit deletions (tombstones)
  -- Use state_with_tombstones to include rows with NULL snapshot_content
  s AS (
    SELECT entity_id, schema_key, file_id, change_id, commit_id, version_id, snapshot_content
    FROM state_with_tombstones
    WHERE version_id = 'test_0000000017'
  ),
  t AS (
    SELECT entity_id, schema_key, file_id, change_id, commit_id, version_id
    FROM state_all
    WHERE version_id = 'test_0000000047'
  ),
  joined AS (
    SELECT
      COALESCE(s.entity_id, t.entity_id) AS entity_id,
      COALESCE(s.schema_key, t.schema_key) AS schema_key,
      COALESCE(s.file_id, t.file_id) AS file_id,
      t.version_id AS before_version_id,
      t.change_id AS before_change_id,
      t.commit_id AS before_commit_id,
      s.version_id AS after_version_id,
      s.change_id AS after_change_id,
      s.commit_id AS after_commit_id,
      CASE
        -- Explicit delete in source (tombstone takes precedence)
        WHEN s.snapshot_content IS NULL THEN 'removed'
        -- Added in source only (live row)
        WHEN t.change_id IS NULL AND s.snapshot_content IS NOT NULL THEN 'added'
        -- Both present and different (live row in source)
        WHEN t.change_id IS NOT NULL AND s.snapshot_content IS NOT NULL AND s.change_id != t.change_id THEN 'modified'
        -- Both present and same (live row in source)
        ELSE 'unchanged'
      END AS status
    FROM s
    LEFT JOIN t ON t.entity_id = s.entity_id AND t.schema_key = s.schema_key AND t.file_id = s.file_id
    UNION ALL
    SELECT
      COALESCE(s.entity_id, t.entity_id) AS entity_id,
      COALESCE(s.schema_key, t.schema_key) AS schema_key,
      COALESCE(s.file_id, t.file_id) AS file_id,
      t.version_id AS before_version_id,
      t.change_id AS before_change_id,
      t.commit_id AS before_commit_id,
      -- For target-only rows (no source contribution), mirror target values for after_*
      -- This represents entities that exist in target but were never in source
      t.version_id AS after_version_id,
      t.change_id AS after_change_id,
      t.commit_id AS after_commit_id,
      CASE
        -- Target-only: entity exists in target but never existed in source (no explicit delete)
        -- Treated as unchanged since source doesn't modify it
        WHEN s.change_id IS NULL AND t.change_id IS NOT NULL THEN 'unchanged'
        ELSE 'unchanged'
      END AS status
    FROM t
    LEFT JOIN s ON s.entity_id = t.entity_id AND s.schema_key = t.schema_key AND s.file_id = t.file_id
    WHERE s.change_id IS NULL
  )
SELECT *
FROM joined
    ) as "diff" where "diff"."status" != ?

-- expanded SQL --
select * from (
WITH
  -- Source side should expose explicit deletions (tombstones)
  -- Use state_with_tombstones to include rows with NULL snapshot_content
  s AS (
    SELECT entity_id, schema_key, file_id, change_id, commit_id, version_id, snapshot_content
    FROM ( SELECT 
      entity_id,
      schema_key,
      file_id,
      version_id,
      plugin_key,
      snapshot_content,
      schema_version,
      created_at,
      updated_at,
      inherited_from_version_id,
      change_id,
      untracked,
      commit_id,
      writer_key,
      (
        SELECT json(metadata)
        FROM change
        WHERE change.id = internal_state_vtable.change_id
      ) AS metadata
    FROM internal_state_vtable ) AS state_with_tombstones
    WHERE version_id = 'test_0000000017'
  ),
  t AS (
    SELECT entity_id, schema_key, file_id, change_id, commit_id, version_id
    FROM ( SELECT 
      entity_id,
      schema_key,
      file_id,
      version_id,
      plugin_key,
      snapshot_content,
      schema_version,
      created_at,
      updated_at,
      inherited_from_version_id,
      change_id,
      untracked,
      commit_id,
      writer_key,
      (
        SELECT json(metadata)
        FROM change
        WHERE change.id = internal_state_vtable.change_id
      ) AS metadata
    FROM internal_state_vtable
    WHERE snapshot_content IS NOT NULL ) AS state_all
    WHERE version_id = 'test_0000000047'
  ),
  joined AS (
    SELECT
      COALESCE(s.entity_id, t.entity_id) AS entity_id,
      COALESCE(s.schema_key, t.schema_key) AS schema_key,
      COALESCE(s.file_id, t.file_id) AS file_id,
      t.version_id AS before_version_id,
      t.change_id AS before_change_id,
      t.commit_id AS before_commit_id,
      s.version_id AS after_version_id,
      s.change_id AS after_change_id,
      s.commit_id AS after_commit_id,
      CASE
        -- Explicit delete in source (tombstone takes precedence)
        WHEN s.snapshot_content IS NULL THEN 'removed'
        -- Added in source only (live row)
        WHEN t.change_id IS NULL AND s.snapshot_content IS NOT NULL THEN 'added'
        -- Both present and different (live row in source)
        WHEN t.change_id IS NOT NULL AND s.snapshot_content IS NOT NULL AND s.change_id != t.change_id THEN 'modified'
        -- Both present and same (live row in source)
        ELSE 'unchanged'
      END AS status
    FROM s
    LEFT JOIN t ON t.entity_id = s.entity_id AND t.schema_key = s.schema_key AND t.file_id = s.file_id
    UNION ALL
    SELECT
      COALESCE(s.entity_id, t.entity_id) AS entity_id,
      COALESCE(s.schema_key, t.schema_key) AS schema_key,
      COALESCE(s.file_id, t.file_id) AS file_id,
      t.version_id AS before_version_id,
      t.change_id AS before_change_id,
      t.commit_id AS before_commit_id,
      -- For target-only rows (no source contribution), mirror target values for after_*
      -- This represents entities that exist in target but were never in source
      t.version_id AS after_version_id,
      t.change_id AS after_change_id,
      t.commit_id AS after_commit_id,
      CASE
        -- Target-only: entity exists in target but never existed in source (no explicit delete)
        -- Treated as unchanged since source doesn't modify it
        WHEN s.change_id IS NULL AND t.change_id IS NOT NULL THEN 'unchanged'
        ELSE 'unchanged'
      END AS status
    FROM t
    LEFT JOIN s ON s.entity_id = t.entity_id AND s.schema_key = t.schema_key AND s.file_id = t.file_id
    WHERE s.change_id IS NULL
  )
SELECT *
FROM joined
    ) as "diff" where "diff"."status" != ?

-- rewritten SQL --
WITH
-- hoisted_internal_state_vtable_rewrite
internal_state_vtable AS (
  WITH RECURSIVE
    version_descriptor_base AS (
      SELECT
        json_extract(desc.snapshot_content, '$.id') AS version_id,
        json_extract(desc.snapshot_content, '$.inherits_from_version_id') AS inherits_from_version_id
      FROM internal_state_cache_lix_version_descriptor desc
    ),
    version_inheritance(version_id, ancestor_version_id) AS (
      SELECT
        vdb.version_id,
        vdb.inherits_from_version_id
      FROM version_descriptor_base vdb
      WHERE vdb.inherits_from_version_id IS NOT NULL

      UNION ALL

      SELECT
        vir.version_id,
        vdb.inherits_from_version_id
      FROM version_inheritance vir
      JOIN version_descriptor_base vdb ON vdb.version_id = vir.ancestor_version_id
      WHERE vdb.inherits_from_version_id IS NOT NULL
    ),
    version_parent AS (
      SELECT
        vdb.version_id,
        vdb.inherits_from_version_id AS parent_version_id
      FROM version_descriptor_base vdb
      WHERE vdb.inherits_from_version_id IS NOT NULL
    )
  ,
    candidates AS (
      SELECT
        'U' || '~' || lix_encode_pk_part(u.file_id) || '~' || lix_encode_pk_part(u.entity_id) || '~' || lix_encode_pk_part(u.version_id) AS _pk,
        u.entity_id,
        u.schema_key,
        u.file_id,
        u.plugin_key,
        json(u.snapshot_content) AS snapshot_content,
        u.schema_version,
        u.version_id AS src_version_id,
        u.version_id AS dst_version_id,
        u.created_at,
        u.updated_at,
        NULL AS inherited_from_version_id,
        'untracked' AS change_id,
        1 AS untracked,
        'untracked' AS commit_id,
        NULL AS metadata,
        2 AS priority
      FROM internal_state_all_untracked u
      WHERE (
        (u.inheritance_delete_marker = 0 AND u.snapshot_content IS NOT NULL) OR
        (u.inheritance_delete_marker = 1 AND u.snapshot_content IS NULL)
      )

      UNION ALL

      SELECT
        'C' || '~' || lix_encode_pk_part(c.file_id) || '~' || lix_encode_pk_part(c.entity_id) || '~' || lix_encode_pk_part(c.version_id) AS _pk,
        c.entity_id,
        c.schema_key,
        c.file_id,
        c.plugin_key,
        json(c.snapshot_content) AS snapshot_content,
        c.schema_version,
        c.version_id AS src_version_id,
        c.version_id AS dst_version_id,
        c.created_at,
        c.updated_at,
        c.inherited_from_version_id,
        c.change_id,
        0 AS untracked,
        c.commit_id,
        NULL AS metadata,
        3 AS priority
      FROM internal_state_cache c
      WHERE (
        (c.inheritance_delete_marker = 0 AND c.snapshot_content IS NOT NULL) OR
        (c.inheritance_delete_marker = 1 AND c.snapshot_content IS NULL)
      )

      UNION ALL

      SELECT
        'CI' || '~' || lix_encode_pk_part(isc.file_id) || '~' || lix_encode_pk_part(isc.entity_id) || '~' || lix_encode_pk_part(vi.version_id) AS _pk,
        isc.entity_id,
        isc.schema_key,
        isc.file_id,
        isc.plugin_key,
        json(isc.snapshot_content) AS snapshot_content,
        isc.schema_version,
        isc.version_id AS src_version_id,
        vi.version_id AS dst_version_id,
        isc.created_at,
        isc.updated_at,
        isc.version_id AS inherited_from_version_id,
        isc.change_id,
        0 AS untracked,
        isc.commit_id,
        NULL AS metadata,
        4 AS priority
      FROM version_inheritance vi
      JOIN internal_state_cache isc ON isc.version_id = vi.ancestor_version_id
      WHERE isc.inheritance_delete_marker = 0
        AND isc.snapshot_content IS NOT NULL

      UNION ALL

      SELECT
        'UI' || '~' || lix_encode_pk_part(unt.file_id) || '~' || lix_encode_pk_part(unt.entity_id) || '~' || lix_encode_pk_part(vi.version_id) AS _pk,
        unt.entity_id,
        unt.schema_key,
        unt.file_id,
        unt.plugin_key,
        json(unt.snapshot_content) AS snapshot_content,
        unt.schema_version,
        unt.version_id AS src_version_id,
        vi.version_id AS dst_version_id,
        unt.created_at,
        unt.updated_at,
        unt.version_id AS inherited_from_version_id,
        'untracked' AS change_id,
        1 AS untracked,
        'untracked' AS commit_id,
        NULL AS metadata,
        5 AS priority
      FROM version_inheritance vi
      JOIN internal_state_all_untracked unt ON unt.version_id = vi.ancestor_version_id
      WHERE unt.inheritance_delete_marker = 0
        AND unt.snapshot_content IS NOT NULL
    ),
    ranked AS (
      SELECT
        c._pk,
        c.entity_id,
        c.schema_key,
        c.file_id,
        c.plugin_key,
        c.snapshot_content,
        c.schema_version,
        c.dst_version_id AS version_id,
        c.created_at,
        c.updated_at,
        c.inherited_from_version_id,
        c.change_id,
        c.untracked,
        c.commit_id,
        COALESCE(c.metadata, ch.metadata) AS metadata,
        COALESCE(ws_dst.writer_key, ws_src.writer_key) AS writer_key,
        c.priority,
        ROW_NUMBER() OVER (
          PARTITION BY c.file_id, c.schema_key, c.entity_id, c.dst_version_id
          ORDER BY c.priority,
                   c.created_at DESC,
                   c._pk
        ) AS rn
      FROM candidates c
      LEFT JOIN change ch ON ch.id = c.change_id
      LEFT JOIN internal_state_writer ws_dst ON
        ws_dst.file_id = c.file_id AND
        ws_dst.entity_id = c.entity_id AND
        ws_dst.schema_key = c.schema_key AND
        ws_dst.version_id = c.dst_version_id
      LEFT JOIN internal_state_writer ws_src ON
        ws_src.file_id = c.file_id AND
        ws_src.entity_id = c.entity_id AND
        ws_src.schema_key = c.schema_key AND
        ws_src.version_id = COALESCE(c.inherited_from_version_id, c.dst_version_id)

    )
  SELECT
    _pk,
    entity_id,
    schema_key,
    file_id,
    plugin_key,
    snapshot_content,
    schema_version,
    version_id,
    created_at,
    updated_at,
    inherited_from_version_id,
    change_id,
    untracked,
    commit_id,
    metadata,
    writer_key
  FROM ranked
  WHERE rn = 1
  ORDER BY priority, _pk
)
select * from (
WITH
  -- Source side should expose explicit deletions (tombstones)
  -- Use state_with_tombstones to include rows with NULL snapshot_content
  s AS (
    SELECT entity_id, schema_key, file_id, change_id, commit_id, version_id, snapshot_content
    FROM ( SELECT 
      entity_id,
      schema_key,
      file_id,
      version_id,
      plugin_key,
      snapshot_content,
      schema_version,
      created_at,
      updated_at,
      inherited_from_version_id,
      change_id,
      untracked,
      commit_id,
      writer_key,
      (
        SELECT json(metadata)
        FROM change
        WHERE change.id = internal_state_vtable.change_id
      ) AS metadata
    FROM (SELECT entity_id, schema_key, file_id, plugin_key, snapshot_content, schema_version, version_id, created_at, updated_at, inherited_from_version_id, change_id, untracked, commit_id, metadata, writer_key FROM internal_state_vtable) AS internal_state_vtable ) AS state_with_tombstones
    WHERE version_id = 'test_0000000017'
  ),
  t AS (
    SELECT entity_id, schema_key, file_id, change_id, commit_id, version_id
    FROM ( SELECT 
      entity_id,
      schema_key,
      file_id,
      version_id,
      plugin_key,
      snapshot_content,
      schema_version,
      created_at,
      updated_at,
      inherited_from_version_id,
      change_id,
      untracked,
      commit_id,
      writer_key,
      (
        SELECT json(metadata)
        FROM change
        WHERE change.id = internal_state_vtable.change_id
      ) AS metadata
    FROM (SELECT entity_id, schema_key, file_id, plugin_key, snapshot_content, schema_version, version_id, created_at, updated_at, inherited_from_version_id, change_id, untracked, commit_id, metadata, writer_key FROM internal_state_vtable) AS internal_state_vtable
    WHERE snapshot_content IS NOT NULL ) AS state_all
    WHERE version_id = 'test_0000000047'
  ),
  joined AS (
    SELECT
      COALESCE(s.entity_id, t.entity_id) AS entity_id,
      COALESCE(s.schema_key, t.schema_key) AS schema_key,
      COALESCE(s.file_id, t.file_id) AS file_id,
      t.version_id AS before_version_id,
      t.change_id AS before_change_id,
      t.commit_id AS before_commit_id,
      s.version_id AS after_version_id,
      s.change_id AS after_change_id,
      s.commit_id AS after_commit_id,
      CASE
        -- Explicit delete in source (tombstone takes precedence)
        WHEN s.snapshot_content IS NULL THEN 'removed'
        -- Added in source only (live row)
        WHEN t.change_id IS NULL AND s.snapshot_content IS NOT NULL THEN 'added'
        -- Both present and different (live row in source)
        WHEN t.change_id IS NOT NULL AND s.snapshot_content IS NOT NULL AND s.change_id != t.change_id THEN 'modified'
        -- Both present and same (live row in source)
        ELSE 'unchanged'
      END AS status
    FROM s
    LEFT JOIN t ON t.entity_id = s.entity_id AND t.schema_key = s.schema_key AND t.file_id = s.file_id
    UNION ALL
    SELECT
      COALESCE(s.entity_id, t.entity_id) AS entity_id,
      COALESCE(s.schema_key, t.schema_key) AS schema_key,
      COALESCE(s.file_id, t.file_id) AS file_id,
      t.version_id AS before_version_id,
      t.change_id AS before_change_id,
      t.commit_id AS before_commit_id,
      -- For target-only rows (no source contribution), mirror target values for after_*
      -- This represents entities that exist in target but were never in source
      t.version_id AS after_version_id,
      t.change_id AS after_change_id,
      t.commit_id AS after_commit_id,
      CASE
        -- Target-only: entity exists in target but never existed in source (no explicit delete)
        -- Treated as unchanged since source doesn't modify it
        WHEN s.change_id IS NULL AND t.change_id IS NOT NULL THEN 'unchanged'
        ELSE 'unchanged'
      END AS status
    FROM t
    LEFT JOIN s ON s.entity_id = t.entity_id AND s.schema_key = t.schema_key AND s.file_id = t.file_id
    WHERE s.change_id IS NULL
  )
SELECT *
FROM joined
    ) as "diff" where "diff"."status" != ?1

-- plan --
[
  {
    "id": 1,
    "parent": 0,
    "notused": 0,
    "detail": "COMPOUND QUERY"
  },
  {
    "id": 2,
    "parent": 1,
    "notused": 0,
    "detail": "LEFT-MOST SUBQUERY"
  },
  {
    "id": 4,
    "parent": 2,
    "notused": 0,
    "detail": "CO-ROUTINE ranked"
  },
  {
    "id": 7,
    "parent": 4,
    "notused": 0,
    "detail": "CO-ROUTINE (subquery-40)"
  },
  {
    "id": 9,
    "parent": 7,
    "notused": 0,
    "detail": "CO-ROUTINE candidates"
  },
  {
    "id": 10,
    "parent": 9,
    "notused": 0,
    "detail": "COMPOUND QUERY"
  },
  {
    "id": 11,
    "parent": 10,
    "notused": 0,
    "detail": "LEFT-MOST SUBQUERY"
  },
  {
    "id": 14,
    "parent": 11,
    "notused": 61,
    "detail": "SEARCH u USING INDEX idx_internal_state_all_untracked_version_id (version_id=?)"
  },
  {
    "id": 57,
    "parent": 10,
    "notused": 0,
    "detail": "UNION ALL"
  },
  {
    "id": 59,
    "parent": 57,
    "notused": 189,
    "detail": "SCAN c VIRTUAL TABLE INDEX 0:version_id"
  },
  {
    "id": 104,
    "parent": 10,
    "notused": 0,
    "detail": "UNION ALL"
  },
  {
    "id": 107,
    "parent": 104,
    "notused": 0,
    "detail": "MATERIALIZE version_inheritance"
  },
  {
    "id": 111,
    "parent": 107,
    "notused": 0,
    "detail": "SETUP"
  },
  {
    "id": 114,
    "parent": 111,
    "notused": 28,
    "detail": "SCAN desc USING COVERING INDEX idx_internal_state_cache_lix_version_descriptor_id_parent"
  },
  {
    "id": 139,
    "parent": 107,
    "notused": 0,
    "detail": "RECURSIVE STEP"
  },
  {
    "id": 142,
    "parent": 139,
    "notused": 216,
    "detail": "SCAN vir"
  },
  {
    "id": 143,
    "parent": 139,
    "notused": 20,
    "detail": "SEARCH desc USING COVERING INDEX idx_internal_state_cache_lix_version_descriptor_id_parent (<expr>=?)"
  },
  {
    "id": 164,
    "parent": 104,
    "notused": 189,
    "detail": "SCAN isc VIRTUAL TABLE INDEX 0:inheritance_delete_marker"
  },
  {
    "id": 177,
    "parent": 104,
    "notused": 0,
    "detail": "BLOOM FILTER ON vi (version_id=?)"
  },
  {
    "id": 189,
    "parent": 104,
    "notused": 53,
    "detail": "SEARCH vi USING AUTOMATIC PARTIAL COVERING INDEX (version_id=?)"
  },
  {
    "id": 228,
    "parent": 10,
    "notused": 0,
    "detail": "UNION ALL"
  },
  {
    "id": 233,
    "parent": 228,
    "notused": 216,
    "detail": "SCAN vi"
  },
  {
    "id": 237,
    "parent": 228,
    "notused": 61,
    "detail": "SEARCH unt USING INDEX idx_internal_state_all_untracked_version_id (version_id=?)"
  },
  {
    "id": 282,
    "parent": 7,
    "notused": 0,
    "detail": "MATERIALIZE change"
  },
  {
    "id": 284,
    "parent": 282,
    "notused": 0,
    "detail": "COMPOUND QUERY"
  },
  {
    "id": 285,
    "parent": 284,
    "notused": 0,
    "detail": "LEFT-MOST SUBQUERY"
  },
  {
    "id": 289,
    "parent": 285,
    "notused": 216,
    "detail": "SCAN c"
  },
  {
    "id": 291,
    "parent": 285,
    "notused": 47,
    "detail": "SEARCH s USING INDEX sqlite_autoindex_internal_snapshot_1 (id=?) LEFT-JOIN"
  },
  {
    "id": 316,
    "parent": 284,
    "notused": 0,
    "detail": "UNION ALL"
  },
  {
    "id": 318,
    "parent": 316,
    "notused": 216,
    "detail": "SCAN t"
  },
  {
    "id": 340,
    "parent": 7,
    "notused": 282,
    "detail": "SCAN c"
  },
  {
    "id": 363,
    "parent": 7,
    "notused": 53,
    "detail": "SEARCH ch USING AUTOMATIC COVERING INDEX (id=?) LEFT-JOIN"
  },
  {
    "id": 370,
    "parent": 7,
    "notused": 45,
    "detail": "SEARCH ws_dst USING PRIMARY KEY (file_id=? AND version_id=? AND entity_id=? AND schema_key=?) LEFT-JOIN"
  },
  {
    "id": 383,
    "parent": 7,
    "notused": 45,
    "detail": "SEARCH ws_src USING PRIMARY KEY (file_id=? AND version_id=? AND entity_id=? AND schema_key=?) LEFT-JOIN"
  },
  {
    "id": 438,
    "parent": 7,
    "notused": 0,
    "detail": "USE TEMP B-TREE FOR ORDER BY"
  },
  {
    "id": 477,
    "parent": 4,
    "notused": 305,
    "detail": "SCAN (subquery-40)"
  },
  {
    "id": 565,
    "parent": 2,
    "notused": 0,
    "detail": "MATERIALIZE ranked"
  },
  {
    "id": 568,
    "parent": 565,
    "notused": 0,
    "detail": "CO-ROUTINE (subquery-41)"
  },
  {
    "id": 570,
    "parent": 568,
    "notused": 0,
    "detail": "CO-ROUTINE candidates"
  },
  {
    "id": 571,
    "parent": 570,
    "notused": 0,
    "detail": "COMPOUND QUERY"
  },
  {
    "id": 572,
    "parent": 571,
    "notused": 0,
    "detail": "LEFT-MOST SUBQUERY"
  },
  {
    "id": 575,
    "parent": 572,
    "notused": 61,
    "detail": "SEARCH u USING INDEX idx_internal_state_all_untracked_version_id (version_id=?)"
  },
  {
    "id": 618,
    "parent": 571,
    "notused": 0,
    "detail": "UNION ALL"
  },
  {
    "id": 620,
    "parent": 618,
    "notused": 189,
    "detail": "SCAN c VIRTUAL TABLE INDEX 0:version_id"
  },
  {
    "id": 665,
    "parent": 571,
    "notused": 0,
    "detail": "UNION ALL"
  },
  {
    "id": 668,
    "parent": 665,
    "notused": 0,
    "detail": "MATERIALIZE version_inheritance"
  },
  {
    "id": 672,
    "parent": 668,
    "notused": 0,
    "detail": "SETUP"
  },
  {
    "id": 675,
    "parent": 672,
    "notused": 28,
    "detail": "SCAN desc USING COVERING INDEX idx_internal_state_cache_lix_version_descriptor_id_parent"
  },
  {
    "id": 700,
    "parent": 668,
    "notused": 0,
    "detail": "RECURSIVE STEP"
  },
  {
    "id": 703,
    "parent": 700,
    "notused": 216,
    "detail": "SCAN vir"
  },
  {
    "id": 704,
    "parent": 700,
    "notused": 20,
    "detail": "SEARCH desc USING COVERING INDEX idx_internal_state_cache_lix_version_descriptor_id_parent (<expr>=?)"
  },
  {
    "id": 725,
    "parent": 665,
    "notused": 189,
    "detail": "SCAN isc VIRTUAL TABLE INDEX 0:inheritance_delete_marker"
  },
  {
    "id": 738,
    "parent": 665,
    "notused": 0,
    "detail": "BLOOM FILTER ON vi (version_id=?)"
  },
  {
    "id": 750,
    "parent": 665,
    "notused": 53,
    "detail": "SEARCH vi USING AUTOMATIC PARTIAL COVERING INDEX (version_id=?)"
  },
  {
    "id": 789,
    "parent": 571,
    "notused": 0,
    "detail": "UNION ALL"
  },
  {
    "id": 794,
    "parent": 789,
    "notused": 216,
    "detail": "SCAN vi"
  },
  {
    "id": 798,
    "parent": 789,
    "notused": 61,
    "detail": "SEARCH unt USING INDEX idx_internal_state_all_untracked_version_id (version_id=?)"
  },
  {
    "id": 843,
    "parent": 568,
    "notused": 0,
    "detail": "MATERIALIZE change"
  },
  {
    "id": 845,
    "parent": 843,
    "notused": 0,
    "detail": "COMPOUND QUERY"
  },
  {
    "id": 846,
    "parent": 845,
    "notused": 0,
    "detail": "LEFT-MOST SUBQUERY"
  },
  {
    "id": 850,
    "parent": 846,
    "notused": 216,
    "detail": "SCAN c"
  },
  {
    "id": 852,
    "parent": 846,
    "notused": 47,
    "detail": "SEARCH s USING INDEX sqlite_autoindex_internal_snapshot_1 (id=?) LEFT-JOIN"
  },
  {
    "id": 877,
    "parent": 845,
    "notused": 0,
    "detail": "UNION ALL"
  },
  {
    "id": 879,
    "parent": 877,
    "notused": 216,
    "detail": "SCAN t"
  },
  {
    "id": 901,
    "parent": 568,
    "notused": 282,
    "detail": "SCAN c"
  },
  {
    "id": 924,
    "parent": 568,
    "notused": 53,
    "detail": "SEARCH ch USING AUTOMATIC COVERING INDEX (id=?) LEFT-JOIN"
  },
  {
    "id": 931,
    "parent": 568,
    "notused": 45,
    "detail": "SEARCH ws_dst USING PRIMARY KEY (file_id=? AND version_id=? AND entity_id=? AND schema_key=?) LEFT-JOIN"
  },
  {
    "id": 944,
    "parent": 568,
    "notused": 45,
    "detail": "SEARCH ws_src USING PRIMARY KEY (file_id=? AND version_id=? AND entity_id=? AND schema_key=?) LEFT-JOIN"
  },
  {
    "id": 999,
    "parent": 568,
    "notused": 0,
    "detail": "USE TEMP B-TREE FOR ORDER BY"
  },
  {
    "id": 1039,
    "parent": 565,
    "notused": 305,
    "detail": "SCAN (subquery-41)"
  },
  {
    "id": 1127,
    "parent": 2,
    "notused": 305,
    "detail": "SCAN ranked"
  },
  {
    "id": 1138,
    "parent": 2,
    "notused": 0,
    "detail": "BLOOM FILTER ON ranked (rn=? AND version_id=? AND entity_id=? AND schema_key=? AND file_id=?)"
  },
  {
    "id": 1162,
    "parent": 2,
    "notused": 56,
    "detail": "SEARCH ranked USING AUTOMATIC PARTIAL COVERING INDEX (rn=? AND version_id=? AND entity_id=? AND schema_key=? AND file_id=?) LEFT-JOIN"
  },
  {
    "id": 1244,
    "parent": 1,
    "notused": 0,
    "detail": "UNION ALL"
  },
  {
    "id": 1246,
    "parent": 1244,
    "notused": 0,
    "detail": "CO-ROUTINE ranked"
  },
  {
    "id": 1249,
    "parent": 1246,
    "notused": 0,
    "detail": "CO-ROUTINE (subquery-42)"
  },
  {
    "id": 1251,
    "parent": 1249,
    "notused": 0,
    "detail": "CO-ROUTINE candidates"
  },
  {
    "id": 1252,
    "parent": 1251,
    "notused": 0,
    "detail": "COMPOUND QUERY"
  },
  {
    "id": 1253,
    "parent": 1252,
    "notused": 0,
    "detail": "LEFT-MOST SUBQUERY"
  },
  {
    "id": 1256,
    "parent": 1253,
    "notused": 61,
    "detail": "SEARCH u USING INDEX idx_internal_state_all_untracked_version_id (version_id=?)"
  },
  {
    "id": 1299,
    "parent": 1252,
    "notused": 0,
    "detail": "UNION ALL"
  },
  {
    "id": 1301,
    "parent": 1299,
    "notused": 189,
    "detail": "SCAN c VIRTUAL TABLE INDEX 0:version_id"
  },
  {
    "id": 1346,
    "parent": 1252,
    "notused": 0,
    "detail": "UNION ALL"
  },
  {
    "id": 1349,
    "parent": 1346,
    "notused": 0,
    "detail": "MATERIALIZE version_inheritance"
  },
  {
    "id": 1353,
    "parent": 1349,
    "notused": 0,
    "detail": "SETUP"
  },
  {
    "id": 1356,
    "parent": 1353,
    "notused": 28,
    "detail": "SCAN desc USING COVERING INDEX idx_internal_state_cache_lix_version_descriptor_id_parent"
  },
  {
    "id": 1381,
    "parent": 1349,
    "notused": 0,
    "detail": "RECURSIVE STEP"
  },
  {
    "id": 1384,
    "parent": 1381,
    "notused": 216,
    "detail": "SCAN vir"
  },
  {
    "id": 1385,
    "parent": 1381,
    "notused": 20,
    "detail": "SEARCH desc USING COVERING INDEX idx_internal_state_cache_lix_version_descriptor_id_parent (<expr>=?)"
  },
  {
    "id": 1406,
    "parent": 1346,
    "notused": 189,
    "detail": "SCAN isc VIRTUAL TABLE INDEX 0:inheritance_delete_marker"
  },
  {
    "id": 1419,
    "parent": 1346,
    "notused": 0,
    "detail": "BLOOM FILTER ON vi (version_id=?)"
  },
  {
    "id": 1431,
    "parent": 1346,
    "notused": 53,
    "detail": "SEARCH vi USING AUTOMATIC PARTIAL COVERING INDEX (version_id=?)"
  },
  {
    "id": 1470,
    "parent": 1252,
    "notused": 0,
    "detail": "UNION ALL"
  },
  {
    "id": 1475,
    "parent": 1470,
    "notused": 216,
    "detail": "SCAN vi"
  },
  {
    "id": 1479,
    "parent": 1470,
    "notused": 61,
    "detail": "SEARCH unt USING INDEX idx_internal_state_all_untracked_version_id (version_id=?)"
  },
  {
    "id": 1524,
    "parent": 1249,
    "notused": 0,
    "detail": "MATERIALIZE change"
  },
  {
    "id": 1526,
    "parent": 1524,
    "notused": 0,
    "detail": "COMPOUND QUERY"
  },
  {
    "id": 1527,
    "parent": 1526,
    "notused": 0,
    "detail": "LEFT-MOST SUBQUERY"
  },
  {
    "id": 1531,
    "parent": 1527,
    "notused": 216,
    "detail": "SCAN c"
  },
  {
    "id": 1533,
    "parent": 1527,
    "notused": 47,
    "detail": "SEARCH s USING INDEX sqlite_autoindex_internal_snapshot_1 (id=?) LEFT-JOIN"
  },
  {
    "id": 1558,
    "parent": 1526,
    "notused": 0,
    "detail": "UNION ALL"
  },
  {
    "id": 1560,
    "parent": 1558,
    "notused": 216,
    "detail": "SCAN t"
  },
  {
    "id": 1582,
    "parent": 1249,
    "notused": 282,
    "detail": "SCAN c"
  },
  {
    "id": 1605,
    "parent": 1249,
    "notused": 53,
    "detail": "SEARCH ch USING AUTOMATIC COVERING INDEX (id=?) LEFT-JOIN"
  },
  {
    "id": 1612,
    "parent": 1249,
    "notused": 45,
    "detail": "SEARCH ws_dst USING PRIMARY KEY (file_id=? AND version_id=? AND entity_id=? AND schema_key=?) LEFT-JOIN"
  },
  {
    "id": 1625,
    "parent": 1249,
    "notused": 45,
    "detail": "SEARCH ws_src USING PRIMARY KEY (file_id=? AND version_id=? AND entity_id=? AND schema_key=?) LEFT-JOIN"
  },
  {
    "id": 1680,
    "parent": 1249,
    "notused": 0,
    "detail": "USE TEMP B-TREE FOR ORDER BY"
  },
  {
    "id": 1719,
    "parent": 1246,
    "notused": 305,
    "detail": "SCAN (subquery-42)"
  },
  {
    "id": 1807,
    "parent": 1244,
    "notused": 0,
    "detail": "MATERIALIZE ranked"
  },
  {
    "id": 1810,
    "parent": 1807,
    "notused": 0,
    "detail": "CO-ROUTINE (subquery-43)"
  },
  {
    "id": 1812,
    "parent": 1810,
    "notused": 0,
    "detail": "CO-ROUTINE candidates"
  },
  {
    "id": 1813,
    "parent": 1812,
    "notused": 0,
    "detail": "COMPOUND QUERY"
  },
  {
    "id": 1814,
    "parent": 1813,
    "notused": 0,
    "detail": "LEFT-MOST SUBQUERY"
  },
  {
    "id": 1817,
    "parent": 1814,
    "notused": 61,
    "detail": "SEARCH u USING INDEX idx_internal_state_all_untracked_version_id (version_id=?)"
  },
  {
    "id": 1860,
    "parent": 1813,
    "notused": 0,
    "detail": "UNION ALL"
  },
  {
    "id": 1862,
    "parent": 1860,
    "notused": 189,
    "detail": "SCAN c VIRTUAL TABLE INDEX 0:version_id"
  },
  {
    "id": 1907,
    "parent": 1813,
    "notused": 0,
    "detail": "UNION ALL"
  },
  {
    "id": 1910,
    "parent": 1907,
    "notused": 0,
    "detail": "MATERIALIZE version_inheritance"
  },
  {
    "id": 1914,
    "parent": 1910,
    "notused": 0,
    "detail": "SETUP"
  },
  {
    "id": 1917,
    "parent": 1914,
    "notused": 28,
    "detail": "SCAN desc USING COVERING INDEX idx_internal_state_cache_lix_version_descriptor_id_parent"
  },
  {
    "id": 1942,
    "parent": 1910,
    "notused": 0,
    "detail": "RECURSIVE STEP"
  },
  {
    "id": 1945,
    "parent": 1942,
    "notused": 216,
    "detail": "SCAN vir"
  },
  {
    "id": 1946,
    "parent": 1942,
    "notused": 20,
    "detail": "SEARCH desc USING COVERING INDEX idx_internal_state_cache_lix_version_descriptor_id_parent (<expr>=?)"
  },
  {
    "id": 1967,
    "parent": 1907,
    "notused": 189,
    "detail": "SCAN isc VIRTUAL TABLE INDEX 0:inheritance_delete_marker"
  },
  {
    "id": 1980,
    "parent": 1907,
    "notused": 0,
    "detail": "BLOOM FILTER ON vi (version_id=?)"
  },
  {
    "id": 1992,
    "parent": 1907,
    "notused": 53,
    "detail": "SEARCH vi USING AUTOMATIC PARTIAL COVERING INDEX (version_id=?)"
  },
  {
    "id": 2031,
    "parent": 1813,
    "notused": 0,
    "detail": "UNION ALL"
  },
  {
    "id": 2036,
    "parent": 2031,
    "notused": 216,
    "detail": "SCAN vi"
  },
  {
    "id": 2040,
    "parent": 2031,
    "notused": 61,
    "detail": "SEARCH unt USING INDEX idx_internal_state_all_untracked_version_id (version_id=?)"
  },
  {
    "id": 2085,
    "parent": 1810,
    "notused": 0,
    "detail": "MATERIALIZE change"
  },
  {
    "id": 2087,
    "parent": 2085,
    "notused": 0,
    "detail": "COMPOUND QUERY"
  },
  {
    "id": 2088,
    "parent": 2087,
    "notused": 0,
    "detail": "LEFT-MOST SUBQUERY"
  },
  {
    "id": 2092,
    "parent": 2088,
    "notused": 216,
    "detail": "SCAN c"
  },
  {
    "id": 2094,
    "parent": 2088,
    "notused": 47,
    "detail": "SEARCH s USING INDEX sqlite_autoindex_internal_snapshot_1 (id=?) LEFT-JOIN"
  },
  {
    "id": 2119,
    "parent": 2087,
    "notused": 0,
    "detail": "UNION ALL"
  },
  {
    "id": 2121,
    "parent": 2119,
    "notused": 216,
    "detail": "SCAN t"
  },
  {
    "id": 2143,
    "parent": 1810,
    "notused": 282,
    "detail": "SCAN c"
  },
  {
    "id": 2166,
    "parent": 1810,
    "notused": 53,
    "detail": "SEARCH ch USING AUTOMATIC COVERING INDEX (id=?) LEFT-JOIN"
  },
  {
    "id": 2173,
    "parent": 1810,
    "notused": 45,
    "detail": "SEARCH ws_dst USING PRIMARY KEY (file_id=? AND version_id=? AND entity_id=? AND schema_key=?) LEFT-JOIN"
  },
  {
    "id": 2186,
    "parent": 1810,
    "notused": 45,
    "detail": "SEARCH ws_src USING PRIMARY KEY (file_id=? AND version_id=? AND entity_id=? AND schema_key=?) LEFT-JOIN"
  },
  {
    "id": 2241,
    "parent": 1810,
    "notused": 0,
    "detail": "USE TEMP B-TREE FOR ORDER BY"
  },
  {
    "id": 2281,
    "parent": 1807,
    "notused": 305,
    "detail": "SCAN (subquery-43)"
  },
  {
    "id": 2369,
    "parent": 1244,
    "notused": 305,
    "detail": "SCAN ranked"
  },
  {
    "id": 2382,
    "parent": 1244,
    "notused": 0,
    "detail": "BLOOM FILTER ON ranked (rn=? AND version_id=? AND entity_id=? AND schema_key=? AND file_id=?)"
  },
  {
    "id": 2402,
    "parent": 1244,
    "notused": 56,
    "detail": "SEARCH ranked USING AUTOMATIC PARTIAL COVERING INDEX (rn=? AND version_id=? AND entity_id=? AND schema_key=? AND file_id=?) LEFT-JOIN"
  }
]