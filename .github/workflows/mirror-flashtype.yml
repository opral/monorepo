name: Mirror flashtype (copy)

on:
  push:
    branches:
      - main
    paths:
      - "packages/flashtype/**"
  workflow_dispatch:

jobs:
  mirror-flashtype:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare mirror contents with note
        run: |
          set -euo pipefail

          SRC="packages/flashtype"
          WORKDIR=$(mktemp -d)

          rsync -av --delete "$SRC"/ "$WORKDIR"/

          cd "$WORKDIR"
          NOTE="> [!NOTE]\n> The repo is mirrored from [opral/monorepo/tree/main/packages/flashtype](https://github.com/opral/monorepo/tree/main/packages/flashtype). This repo serves as an issue tracker."
          if [ -f README.md ]; then
            if ! grep -q "The repo is mirrored from .*flashtype" README.md; then
              tmpfile=$(mktemp)
              printf "%b\n\n" "$NOTE" > "$tmpfile"
              cat README.md >> "$tmpfile"
              mv "$tmpfile" README.md
            fi
          else
            printf "%b\n" "$NOTE" > README.md
          fi

          echo "WORKDIR=$WORKDIR" >> "$GITHUB_ENV"

      - name: Push to flashtype mirror
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.MIRROR_PAT }}
        with:
          source-directory: ${{ env.WORKDIR }}
          destination-github-username: opral
          destination-repository-name: flashtype
          target-branch: main
          user-email: dev@opral.com
          user-name: opral-bot
