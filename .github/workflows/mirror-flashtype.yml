name: Mirror flashtype (copy)

on:
  push:
    branches:
      - main
    paths:
      - "packages/flashtype/**"
  workflow_dispatch:

jobs:
  mirror-flashtype:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare mirror contents with note
        run: |
          set -euo pipefail

          SRC="packages/flashtype"
          WORKDIR="$GITHUB_WORKSPACE/.mirror-flashtype"

          rm -rf "$WORKDIR"
          mkdir -p "$WORKDIR"

          rsync -av --delete "$SRC"/ "$WORKDIR"/

          cd "$WORKDIR"
          NOTE="> [!NOTE]\n> This repo is mirrored from [opral/monorepo](https://github.com/opral/monorepo/tree/main/packages/flashtype). Use this mirrored repo as the issue tracker."
          if [ -f README.md ]; then
            if ! grep -q "The repo is mirrored from .*flashtype" README.md; then
              tmpfile=$(mktemp)
              printf "%b\n\n" "$NOTE" > "$tmpfile"
              cat README.md >> "$tmpfile"
              mv "$tmpfile" README.md
            fi
          else
            printf "%b\n" "$NOTE" > README.md
          fi

      - name: Push to flashtype mirror
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.MIRROR_PAT }}
        with:
          source-directory: .mirror-flashtype
          destination-github-username: opral
          destination-repository-name: flashtype
          target-branch: main
          user-email: dev@opral.com
          user-name: opral-bot
